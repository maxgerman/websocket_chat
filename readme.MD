 # Websockets chat documentation  ## General flow Here is the desciption of the general flow, each of the steps is described in more detail after in the subtopics that follow. Lastly, there is working example page (html + js) useful for testing and reference.  Steps: - open websocket by url containing *other_member_id* - the one you want to open the chat with - authorize by sending the access_token in the first message - if authorization is successful you will get the response with the chat history -- as the list of messages (json) in predefined format - if auth is unsuccessful - websocket is closed - history is sent back to you - send/receive messages in real time to/from the open socket; if the other member is offline - messages are saved in the history and will be delivered as soon as the other member logins - if any erros occur after authorization (incorrect msg format, file not found, etc.) - they will be sent to websocket as json with error description, web socket is NOT closed in this case - closed tab/browser closes the socket  ## url  Use the url like this to open the websocket: >	ws://localhost:8000/members/chat/?other_member_id={other_member_id}  ## authorizaiton Send the first message to WS as: >Bearer *access_token*  Use the same access_token as with other parts of the site -- received after POST to login endpoint.  ## chat history Sent to websocket once you authorize - in the form of the list of the message objects. Each of the messages have the field 'type' (see message types).   ## message types There are three types of messages: **text**, **smile**, **file**. Which when received look like these:  -   {"id": 87, "member_id": 1, "chat_id": 2, "date": "2022-09-02T15:27:34.857355", "type": "text", "text": "Hello, world!"} -   {"id": 88, "member_id": 1, "chat_id": 2, "date": "2022-09-02T15:27:49.783958", "type": "smile", "smile_id": 2, "smile_file_uuid": "b1d24593-9166-408a-bf68-a8f7be00e181"} -   {"id": 89, "member_id": 1, "chat_id": 2, "date": "2022-09-02T15:29:23.598871", "type": "file", "file_uuid": "84d8a07a-67ca-4d92-8d1e-f5e646b72fb7", "text": "Here's the file!"}   ## message sending Each type has its format and has some requirements. - ### text Just send to the open websocket the message of explicit type or plain text which will be considered text format as well: >{"type": "text", "text": "Hello, world!"}  Or >"hey"  &nbsp;  - ### smile Send to the open websocket: > -   {"type": "smile", "smile_id": 2}  Smile must exist. To create a smile, upload any image and get its id: : POST file as a superuser to */storage/smiles* (as 'form-data' with field name = 'file') &nbsp;  -  ### file Sending of files is a bit more complex as we cannot send them in json, nor do the websockets have forms like http. In essence, frontend codes the needed file info  + message (if any) and combines it with the file data in order to send the resulting byte stream to the socket in one go. The example JS code is included. Can be with or without text attached to them. Size limitation checked at backed (default = 5 000 000 bytes)  ## message pricing  Ensure the  users have some balance for chat testing OR they're superusers/employees/premium users. For ordinary users smiles have custom price for each, other message types have the  default price of 5 coins.   ## Example my html with js   t.me/Max_G